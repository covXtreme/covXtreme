%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[a4paper,10pt]{article}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{natbib,upgreek,mathtools}
\usepackage{rotating, caption}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{cprotect}
\usepackage{color}
\usepackage{fullpage}
\usepackage{titlesec}
\usepackage{hyperref}
\usepackage{bbm}
\usepackage{amsmath}
\usepackage[dvipsnames]{xcolor}
\newcommand{\sectionbreak}{\clearpage}
%\usepackage[nolists]{endfloat}
\setcounter{section}{-1}\input{Phil_Preamble.tex}

\begin{document}

\title{\textbf{Contour estimation using Penalised Piecewise Constant marginal and conditional extreme value models}}
\author{Emma Ross\thanks{Corresponding author. Email: {\tt e.ross@shell.com}}, David Randell, Philip Jonathan}
%\author{Bob}
\date{\today}
%\date{} %nodate
\maketitle
%-------------------------------------------------------------------------------

%-------------------------------------------------------------------------------
\begin{abstract}
	This report describes the Penalised Piecewise Constant (PPC) model and software for estimation of environmental design contours using the conditional extremes model of \cite{HffTwn04}. The sample is composed of peaks over threshold values for both a conditioning variate and its \emph{associated} conditioned variates. Each pair is allocated to a particular \emph{covariate bin}; all (joint) observations with the same covariate bin are assumed to have common extreme value characteristics. The non-stationary marginal extreme value characteristics of each variate is estimated using roughness-penalised maximum likelihood estimation using a generalised Pareto (GP) model above the threshold and gamma below. The extremal dependence structure between the variates on a transformed standard scale (Gumbel or Laplace) is then estimated using a conditional extremes model, also piecewise non-stationary with respect to covariates. Different approaches to contour estimation, generally reliant on simulation under the fitted models, are outlined.
	\newline \newline \newline \newline \newline \newline
	\noindent\textbf{Major Updates Since Previous Release}
	\begin{itemize}
		\item Extended to more than one covariate and non-periodic covariates;
		\item Hefferenan and Tawn model extended from bivariate to multivariate cases; 
		\item Marginal model now fits a Gamma distribution below the threshold, instead of an empirical distribution;
		\item Margins can now be transformed to either Laplace or Gumbel scale (the Laplace scale more naturally handles negative dependence);
		\item Improvements to memory usage and speed of return value estimation;
		\item Use of importance sampling to speed up computation of contours;
		\item Alteration to contouring options: empirical and Heffernan and Tawn (H\&T) density contouring methods merged; radial quantile method replaced with Huseby contour (similar concept but more rigorously defined); \textcolor{red}{}
		\item Contour levels are derived from the same return periods used in the Marginal and H\&T stages, i.e. no longer defined by probability level on the conditioned variable
	\end{itemize}
\end{abstract}

%
\tableofcontents

%\listoffigures




\section{Introduction}
%
The conditional extremes model of \cite{HffTwn04}, and extensions such as \cite{JntEwnRnd14}, \cite{KefPpsTan13} provide a framework to estimate multivariate extremal dependence in the presence of covariates, and hence to estimate design contours and other statistics of interest in metocean design. The approach is motivated by an asymptotic form for the limiting conditional distribution of one or more conditioned random variables given a large value of a conditioning variable. An outline of the approach is given by \cite{JntFlnEwn10}. Conditions for the asymptotic argument to hold have been explored by \cite{HffRsn07}.

Suppose we want to estimate design contours using the conditional extremes model for bivariate peaks over threshold of random variables $\dot{Y}_1$ and $\dot{Y}_2$. These variables might be significant wave height $H_S$ and associated peak period $T_P$, and the dependence between them might be non-stationary with respect to covariates $\boldsymbol{X}$ such as season or storm direction. We then want to simulate realisations under the model, and use the simulation to estimate design contours. We propagate uncertainties due to tuning parameter choice (specifically, threshold levels for marginal and dependence models) and sampling throughout the inference, so that design contours reflect these.

Non-stationarity with respect to covariates $\boldsymbol{X}$ is captured in the model using a Penalized Piecewise Constant (PPC) approach. Namely, covariates are split into bins considered to be roughly homogeneous. Model parameters are then estimated as constants within each covariate bin. To avoid over-fitting, a penalty on the parameter difference between covariate bins can be imposed, e.g. for the non-stationary GP scale parameter. An appropriate value for this roughness penalty is estimated using k-fold cross validation. Other parameters, such as the rate of concurrence and threshold, are simply estimated independently per covariate bin.
\\
Below we give an overview of the 5 stages of analysis included in the PPC software. Note that these stages are described here in terms of the simplest application of the software, namely using one conditioned and one associated response varying with respect to a single covariate. The approach extends easily to a higher number of associated responses and covariates, and indeed the software can be used for such analysis. 
\begin{enumerate}
\item The first stage deals with finding or simulating storm peaks. Peaks are chosen using the main (conditioning) variable $\dot{Y}_1$. $\dot{Y}_2$ is then the associated value at the time of the storm peak in $\dot{Y}_1$. This is discussed in section \ref{Sec:Stg1}.
\item Secondly the user splits the data into bins based on the marginal response characteristics. This is discussed in section \ref{Sec:Stg2}.
\item The marginal PPC models for the distribution of $\dot{Y}_1$ and $\dot{Y}_2$ are then fitted in turn and are used to transform response data on the original scale, $\{\dot{y}_{1i},\dot{y}_{2i}\}_{i=1}^{N}$, to data on Gumbel or Laplace scale, $\{y_{1i},y_{2i}\}_{i=1}^{N}$. Details of this step are discussed in section \ref{Sec:Stg3}.
\item We then fit a conditional extremes model for $Y_2|Y_1$ for various choices of threshold for the conditioning variate, retaining the estimated model parameters and residuals. This is discussed in section \ref{Sec:Stg4}.
\item Finally, we estimate design contours. Using the output from the marginal and conditional extremes model, Monte Carlo simulations are run and contours drawn using various methods. Details of this step are discussed in Section \ref{Sec:Stg5}.
\end{enumerate}

This software was developed as part of a project part-funded by the European Union ERANET entitled “Environmental Contours for SAfe DEsign
of Ships and other marine structures" (ECSADES), along with a review paper on the definition and application of environmental contours \citep{RssOE19}. Further, this software is applied to analysis of surge in the Northern North Sea and described in detail in \cite{RssEA17b}. 

\noindent\textbf{List Of Symbols}
\begin{itemize}
	\item $D$ = total number of dimensions / responses Y, indexed by $d$
	\item $N$ = number of observations, i.e. length of $Y$
	\item $i$ = index on response or covariate observation ($\in \{1,\ldots,N\}$) 
	\item $C$ = total number of covariates, indexed by $c$
	\item $B$ = total number of covariate bins, indexed by $b$
	\item $\dot{Y}$ = response data on original scale
	\item $Y$ = random variable representing response data on standard (Laplace or Gumbel) scale
	\item $X$ = random variable representing covariate data 
	\item $R$ = number of different return-periods in analysis (return-value CDFs and contours)
	\item $t$ = storm-picking non-exceedance probability (Stage 1)
	\item $\tau$ = non-exceedance probability for marginal modelling (Stage 3)
	\item $\psi$ = threshold associated with non-exceedance probability $\tau$ for marginal modelling (Stage 3)
	\item $\xi, \nu$ = marginal model parameters for the generalised Pareto distribution above the threshold 
	\item $\omega, \kappa, l$ = marginal model parameters for Gamma distribution below the threshold
	\item $\lambda$ = marginal model roughness penalty on extent to which $\nu$ can vary by covariate bin (Stage 3)
	\item $\tilde{\tau}$ = non-exceedance probability for Heffernan \& Tawn modelling (Stage 4)
	\item $\phi$ = threshold associated with non-exceedance probability  $\tilde{\tau}$ for Heffernan \& Tawn modelling (Stage 4)
	\item $\alpha, \beta, \mu, \sigma$ = Heffernan \& Tawn model parameters
	\item $\tilde{\lambda}$  = Heffernan \& Tawn model roughness penalty on extent to which $\alpha$ can vary by covariate bin (Stage 4)
\end{itemize}




%-------------------------------------------------------------------------------
\section{Stage 1: Data preparation}  \label{Sec:Stg1}
\input{Stage1_Guide.tex}
%-------------------------------------------------------------------------------
\section{Stage 2: Choose covariate bins} \label{Sec:Stg2}
\input{Stage2_Guide.tex}
%-------------------------------------------------------------------------------
\section{Stage 3: Fit marginal PPC models} \label{Sec:Stg3}
\input{Stage3_Guide.tex}
%-------------------------------------------------------------------------------
\section{Stage 4: Fit conditional extremes model} \label{Sec:Stg4}
\input{Stage4_Guide.tex}
%-------------------------------------------------------------------------------
↑\section{Stage 5: Draw contours} \label{Sec:Stg5}
\input{Stage5_Guide.tex}


\section{Example: Multiple Associated Variables and Covariates} \label{Sec:Exm}
\input{HigherDExample.tex}


%\section{Case studies}
%\input{Case_studies.tex}
%-------------------------------------------------------------------------------
%\section{Discussion}
%\input{Discussion.tex}
%
%%-------------------------------------------------------------------------------
\appendix
\input{Appendix.tex}

%-------------------------------------------------------------------------------
\bibliographystyle{plainnat}
\bibliography{phil}
%-------------------------------------------------------------------------------

%-------------------------------------------------------------------------------
\end{document}
%-------------------------------------------------------------------------------
